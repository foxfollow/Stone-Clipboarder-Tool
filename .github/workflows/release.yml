name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: macos-26

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate secrets
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          if [ -z "$SPARKLE_PRIVATE_KEY" ]; then
            echo "ERROR: SPARKLE_PRIVATE_KEY secret is required but not set"
            exit 1
          fi
          echo "All required secrets are present"

      - name: Setup Xcode
        run: |
          # List available Xcode versions
          echo "Available Xcode versions:"
          ls -la /Applications/ | grep Xcode || echo "Xcode paths not found"

          # Use Xcode 26.x
          if [ -d "/Applications/Xcode_26.1.1.app" ]; then
            sudo xcode-select -s /Applications/Xcode_26.1.1.app/Contents/Developer
          elif [ -d "/Applications/Xcode_26.1.app" ]; then
            sudo xcode-select -s /Applications/Xcode_26.1.app/Contents/Developer
          elif [ -d "/Applications/Xcode_26.0.app" ]; then
            sudo xcode-select -s /Applications/Xcode_26.0.app/Contents/Developer
          else
            echo "ERROR: No suitable Xcode 26.x version found"
            exit 1
          fi

          xcodebuild -version
          swift --version

      - name: Install Sparkle tools
        run: |
          brew install --cask sparkle
          echo "Sparkle installation completed"

      - name: Find Sparkle sign_update tool
        id: sparkle
        run: |
          SIGN_UPDATE_PATH=""
          for sparkle_dir in /opt/homebrew/Caskroom/sparkle/*/bin /usr/local/Caskroom/sparkle/*/bin; do
            if [ -f "$sparkle_dir/sign_update" ]; then
              SIGN_UPDATE_PATH="$sparkle_dir/sign_update"
              xattr -d com.apple.quarantine "$SIGN_UPDATE_PATH" 2>/dev/null || true
              chmod +x "$SIGN_UPDATE_PATH"
              break
            fi
          done

          if [ -z "$SIGN_UPDATE_PATH" ]; then
            echo "ERROR: sign_update tool not found"
            exit 1
          fi

          echo "SIGN_UPDATE_PATH=$SIGN_UPDATE_PATH" >> $GITHUB_OUTPUT
          echo "sign_update_path=$SIGN_UPDATE_PATH" >> $GITHUB_ENV

      - name: Build app (unsigned, no hardened runtime, no sandbox)
        run: |
          echo "Building unsigned app for distribution..."
          xcodebuild archive \
            -project StoneClipboarderTool.xcodeproj \
            -scheme StoneClipboarderTool \
            -configuration Release \
            -archivePath build/StoneClipboarderTool.xcarchive \
            -destination "platform=macOS" \
            ARCHS="arm64" \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_ENTITLEMENTS="" \
            ENABLE_HARDENED_RUNTIME=NO \
            ENABLE_USER_SELECTED_FILES=NO \
            | tee build.log

          echo "Build completed successfully"

      - name: Export app from archive
        run: |
          # Create export options plist for unsigned app
          cat > build/ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>mac-application</string>
              <key>signingStyle</key>
              <string>manual</string>
              <key>stripSwiftSymbols</key>
              <true/>
          </dict>
          </plist>
          EOF

          # Export the archive
          xcodebuild -exportArchive \
            -archivePath build/StoneClipboarderTool.xcarchive \
            -exportPath build/Release \
            -exportOptionsPlist build/ExportOptions.plist \
            | tee -a build.log

          echo "Export completed"

      - name: Verify build
        run: |
          APP_PATH="build/Release/StoneClipboarderTool.app"

          if [ ! -d "$APP_PATH" ]; then
            echo "ERROR: App not found after export"
            ls -la build/Release/
            exit 1
          fi

          MAIN_EXEC="$APP_PATH/Contents/MacOS/StoneClipboarderTool"
          if [ ! -f "$MAIN_EXEC" ]; then
            echo "ERROR: Main executable not found"
            exit 1
          fi

          echo "✓ App bundle structure verified"
          echo "✓ Main executable: $(file "$MAIN_EXEC")"
          echo "✓ Code signature: $(codesign -dv "$APP_PATH" 2>&1 | grep -E 'Signature|Identifier')"

      - name: Create release directory and copy app
        run: |
          mkdir -p release
          cp -R build/Release/StoneClipboarderTool.app release/

          echo "App copied to release directory"
          ls -la release/

      - name: Create installation instructions
        run: |
          cat > release/INSTALL.txt << 'EOF'
          StoneClipboarderTool Installation Instructions
          ==============================================

          This app is unsigned (no Apple Developer ID).

          INSTALLATION (Choose ONE method):

          Method 1 - Right-Click (Easiest):
          1. Extract StoneClipboarderTool.app from ZIP
          2. Move to /Applications/
          3. Right-click → "Open"
          4. Click "Open" in security dialog

          Method 2 - Terminal:
          ```bash
          xattr -cr /Applications/StoneClipboarderTool.app
          ```

          After first launch, auto-updates via Sparkle will work normally.

          Source: https://github.com/foxfollow/Stone-Clipboarder-Tool
          EOF

          cat release/INSTALL.txt

      - name: Create ZIP
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          cd release

          # Create ZIP with app and instructions
          ditto -c -k --sequesterRsrc --keepParent StoneClipboarderTool.app StoneClipboarderTool.zip
          zip -u StoneClipboarderTool.zip INSTALL.txt

          # Verify ZIP
          if [ ! -f "StoneClipboarderTool.zip" ]; then
            echo "ERROR: ZIP creation failed"
            exit 1
          fi

          unzip -t StoneClipboarderTool.zip > /dev/null || exit 1
          echo "✓ ZIP created and verified"

          # Get file size
          SIZE=$(stat -f%z StoneClipboarderTool.zip)
          echo "File size: $SIZE bytes"

          # Sign with Sparkle
          SIGNATURE="UNSIGNED_BUILD"
          if [ -n "$SPARKLE_PRIVATE_KEY" ]; then
            echo "$SPARKLE_PRIVATE_KEY" > ../sparkle_key.txt
            SIGN_OUTPUT=$("${{ env.sign_update_path }}" -f ../sparkle_key.txt StoneClipboarderTool.zip 2>&1)
            if [ $? -eq 0 ]; then
              if echo "$SIGN_OUTPUT" | grep -q "sparkle:edSignature="; then
                SIGNATURE=$(echo "$SIGN_OUTPUT" | grep -o 'sparkle:edSignature="[^"]*"' | cut -d'"' -f2)
              elif echo "$SIGN_OUTPUT" | grep -qE '[A-Za-z0-9+/]+=*$'; then
                SIGNATURE=$(echo "$SIGN_OUTPUT" | grep -oE '[A-Za-z0-9+/]+=*$' | head -1)
              fi
            fi
            rm -f ../sparkle_key.txt
          fi

          echo "SPARKLE_SIGNATURE=$SIGNATURE" >> $GITHUB_ENV
          echo "FILE_SIZE=$SIZE" >> $GITHUB_ENV
          echo "Signature: $SIGNATURE"

      - name: Get version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update appcast
        run: |
          if [ -f docs/appcast.xml ]; then
            cp docs/appcast.xml docs/appcast.xml.backup

            if grep -q "SIGNATURE_PLACEHOLDER" docs/appcast.xml || grep -q "FILE_SIZE" docs/appcast.xml; then
              echo "Updating appcast.xml..."
              sed -i '' '1,/SIGNATURE_PLACEHOLDER/{s|SIGNATURE_PLACEHOLDER|'"$SPARKLE_SIGNATURE"'|;}' docs/appcast.xml
              sed -i '' '1,/FILE_SIZE/{s|FILE_SIZE|'"$FILE_SIZE"'|;}' docs/appcast.xml
              echo "✓ Appcast updated"
            fi
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/StoneClipboarderTool.zip
          tag_name: v${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## Installation Instructions (Unsigned App)

            **Right-Click Method (Easiest):**
            1. Extract and move to /Applications/
            2. Right-click → "Open"
            3. Click "Open" in dialog

            **Terminal Method:**
            ```bash
            xattr -cr /Applications/StoneClipboarderTool.app
            ```

            See `INSTALL.txt` in ZIP for details.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit updated appcast
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          if ! git diff --quiet docs/appcast.xml; then
            git fetch origin main
            git checkout main
            git pull origin main
            git add docs/appcast.xml
            git commit -m "Auto-update appcast.xml for release $VERSION [skip ci]"
            git push origin main
            echo "✓ Appcast committed"
          fi
