name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: macos-15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Validate secrets
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          if [ -z "$SPARKLE_PRIVATE_KEY" ]; then
            echo "ERROR: SPARKLE_PRIVATE_KEY secret is required but not set"
            echo "Please add your Sparkle private key as a repository secret"
            exit 1
          fi
          echo "All required secrets are present"

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.0"

      - name: Install Sparkle tools
        run: |
          brew install --cask sparkle
          echo "Sparkle installation completed"

      - name: Find and setup Sparkle
        id: sparkle
        run: |
          # Find Sparkle installation
          SIGN_UPDATE_PATH=""
          
          # Check common locations
          for sparkle_dir in /opt/homebrew/Caskroom/sparkle/*/bin /usr/local/Caskroom/sparkle/*/bin; do
            if [ -f "$sparkle_dir/sign_update" ]; then
              SIGN_UPDATE_PATH="$sparkle_dir/sign_update"
              echo "Found sign_update at: $SIGN_UPDATE_PATH"
              chmod +x "$SIGN_UPDATE_PATH"
              break
            fi
          done
          
          if [ -z "$SIGN_UPDATE_PATH" ]; then
            echo "ERROR: sign_update tool not found"
            exit 1
          fi
          
          echo "SIGN_UPDATE_PATH=$SIGN_UPDATE_PATH" >> $GITHUB_OUTPUT
          echo "sign_update_path=$SIGN_UPDATE_PATH" >> $GITHUB_ENV

      - name: List schemes
        run: |
          xcodebuild -project StoneClipboarderTool.xcodeproj -list

      - name: Build app
        run: |
          echo "Starting build process..."
          xcodebuild -project StoneClipboarderTool.xcodeproj \
            -scheme StoneClipboarderTool \
            -configuration Release \
            -derivedDataPath build \
            -destination "platform=macOS" \
            -allowProvisioningUpdates \
            MACOSX_DEPLOYMENT_TARGET=15.0 \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=NO \
            | tee build.log
          echo "Build completed"

      - name: Verify build
        run: |
          echo "Checking build output..."
          ls -la build/Build/Products/Release/ || echo "Release folder not found"

          if [ ! -d "build/Build/Products/Release/StoneClipboarderTool.app" ]; then
            echo "Build failed - app not found"
            echo "Build log:"
            cat build.log || echo "No build log found"
            echo "Checking all build products:"
            find build/ -name "*.app" -type d 2>/dev/null || echo "No .app bundles found"
            exit 1
          fi
          echo "App built successfully at: build/Build/Products/Release/StoneClipboarderTool.app"
          ls -la "build/Build/Products/Release/StoneClipboarderTool.app"

      - name: Create app bundle
        run: |
          mkdir -p release
          cp -r build/Build/Products/Release/StoneClipboarderTool.app release/
          ls -la release/

      - name: Sign update
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          if [ -z "$SPARKLE_PRIVATE_KEY" ]; then
            echo "SPARKLE_PRIVATE_KEY secret not found"
            exit 1
          fi

          # Create private key file
          echo "$SPARKLE_PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem
          
          # Basic validation that the private key file was created
          if [ ! -f "private_key.pem" ] || [ ! -s "private_key.pem" ]; then
            echo "ERROR: Failed to create private key file"
            exit 1
          fi
          
          echo "Private key file created successfully"

          cd release
          zip -r StoneClipboarderTool.zip StoneClipboarderTool.app

          # Use the dynamically found path
          SIGN_UPDATE="${{ env.sign_update_path }}"
          echo "Using sign_update at: $SIGN_UPDATE"
          
          # Validate sign_update exists and is executable
          if [ ! -f "$SIGN_UPDATE" ]; then
            echo "ERROR: sign_update not found at $SIGN_UPDATE"
            exit 1
          fi
          
          if [ ! -x "$SIGN_UPDATE" ]; then
            echo "Making sign_update executable"
            chmod +x "$SIGN_UPDATE"
          fi

          # Sign the update
          echo "Signing StoneClipboarderTool.zip..."
          SIGNATURE=$("$SIGN_UPDATE" ../private_key.pem StoneClipboarderTool.zip)
          SIGN_EXIT_CODE=$?
          
          echo "Exit code: $SIGN_EXIT_CODE"
          echo "Signature: $SIGNATURE"

          if [ $SIGN_EXIT_CODE -ne 0 ] || [ -z "$SIGNATURE" ]; then
            echo "ERROR: Failed to generate signature"
            echo "Private key info:"
            ls -la ../private_key.pem
            echo "ZIP file info:"
            ls -la StoneClipboarderTool.zip
            echo "sign_update version:"
            "$SIGN_UPDATE" --version || echo "No version info available"
            rm -f ../private_key.pem
            exit 1
          fi

          echo "SPARKLE_SIGNATURE=$SIGNATURE" >> $GITHUB_ENV
          echo "Successfully generated signature: $SIGNATURE"

          # Clean up private key
          rm -f ../private_key.pem

      - name: Get version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Processing version: $VERSION"

      - name: Update appcast
        run: |
          SIZE=$(stat -f%z release/StoneClipboarderTool.zip)
          DATE=$(date -u +"%a, %d %b %Y %H:%M:%S %z")
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/v$VERSION/StoneClipboarderTool.zip"

          echo "File size: $SIZE bytes"
          echo "Date: $DATE"
          echo "Signature: $SPARKLE_SIGNATURE"
          echo "Download URL: $DOWNLOAD_URL"

          # Backup original appcast
          cp docs/appcast.xml docs/appcast.xml.backup

          # Update appcast with new values
          sed -i '' "s|SIGNATURE_WILL_BE_GENERATED|$SPARKLE_SIGNATURE|g" docs/appcast.xml
          sed -i '' "s|foxfollow|${{ github.repository_owner }}|g" docs/appcast.xml
          sed -i '' "s|1\.0\.0|$VERSION|g" docs/appcast.xml
          sed -i '' "s|length=\"0\"|length=\"$SIZE\"|g" docs/appcast.xml
          sed -i '' "s|Mon, 08 Aug 2025 12:00:00 +0000|$DATE|g" docs/appcast.xml
          sed -i '' "s|Stone-Clipboarder-Tool|${{ github.event.repository.name }}|g" docs/appcast.xml
          sed -i '' "s|download/v1.0.0/|download/v$VERSION/|g" docs/appcast.xml

          echo "Updated appcast.xml:"
          cat docs/appcast.xml

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/StoneClipboarderTool.zip
          tag_name: v${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          force_orphan: true
